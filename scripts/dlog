#!/usr/bin/env bash

COMPOSE_DIR="${COMPOSE_DIR:-$HOME/dev/anyfin/environments}"

for cmd in docker fzf; do
  if ! command -v "$cmd" &>/dev/null; then
    echo "Error: Required command '$cmd' is not installed." >&2
    exit 1
  fi
done

if [ ! -d "$COMPOSE_DIR" ]; then
  echo "Error: Docker Compose directory not found: $COMPOSE_DIR"
  exit 1
fi

cd "$COMPOSE_DIR" || exit 1
if [ ! -f "compose.yml" ]; then
  echo "No docker-compose.yml found in $COMPOSE_DIR"
  exit 1
fi

running_services=$(docker compose ps --services)
[ -z "$running_services" ] && echo "No running services to show logs for." && exit 0

selected=$(echo "$running_services" | fzf -m \
  --header="Select services to tail logs (Tab to toggle, Enter to confirm)"
)

[ -z "$selected" ] && exit 0

echo "Tailing logs for selected services (press Ctrl+C to stop)..."
docker compose logs -f $selected
