#!/usr/bin/env bash

COMPOSE_DIR="${COMPOSE_DIR:-$HOME/dev/anyfin/environments}"

for cmd in docker fzf; do
  if ! command -v "$cmd" &>/dev/null; then
    echo "Error: Required command '$cmd' is not installed." >&2
    exit 1
  fi
done

if [ ! -d "$COMPOSE_DIR" ]; then
  echo "Error: Docker Compose directory not found: $COMPOSE_DIR"
  exit 1
fi

cd "$COMPOSE_DIR" || exit 1
if [ ! -f "compose.yml" ]; then
  echo "No docker-compose.yml found in $COMPOSE_DIR"
  exit 1
fi

running_services=$(docker compose ps --services)
[ -z "$running_services" ] && echo "No running services to stop." && exit 0

preview_cmd='
    echo "=== Running Services ==="
    docker compose ps --services | sed "s/^/  - /"
    echo
    echo "=== Services Selected to Stop ==="
    echo {+} | sed "s/^/  - /"
'

selected=$(
  echo "$running_services" | fzf -m \
    --header="Select services to stop (Tab to toggle, Enter to confirm)" \
    --preview "$preview_cmd" \
    --preview-window=right:40%:wrap \
    --bind="tab:toggle+clear-query+refresh-preview" \
    --bind="enter:accept" \
    --bind="esc:cancel"
)

[ -z "$selected" ] && exit 0

echo "Stopping selected services..."
echo "$selected" | xargs docker compose stop
